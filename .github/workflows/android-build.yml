name: Android CI - Build APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: Make gradlew executable
      run: chmod +x ./gradlew
      
    - name: Validate Gradle wrapper
      uses: gradle/actions/wrapper-validation@v3
      continue-on-error: true
      timeout-minutes: 2
      
    - name: Clone llama.cpp sources
      run: |
        git clone --depth 1 --branch master https://github.com/ggerganov/llama.cpp.git app/src/main/cpp/llama.cpp
        echo "Verifying llama.cpp files..."
        ls -la app/src/main/cpp/llama.cpp/src/
        ls -la app/src/main/cpp/llama.cpp/ggml/src/
      
    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace
      
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: saaya-debug-apk
        path: app/build/outputs/apk/debug/*.apk
        
    - name: Create Release
      if: github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: Saaya AI v1.0.${{ github.run_number }}
        body: |
          ## Saaya AI - Offline AI Chat App
          
          ### Features
          - Runs Llama 3.1 8B Quantized Model offline
          - Simple chat interface
          - Optimized for 16GB RAM devices
          
          ### Installation
          1. Download the APK below
          2. Install on your Android device (Enable "Install from unknown sources")
          3. Launch app and grant storage permissions
          4. Select your .gguf model file
          5. Start chatting!
          
          ### Requirements
          - Android 7.0+
          - 8GB+ RAM
          - 6-7GB free storage
          - Llama 3.1 8B .gguf model file
        files: app/build/outputs/apk/debug/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
